!function t(e,n,r){function o(i,u){if(!n[i]){if(!e[i]){var a="function"==typeof require&&require;if(!u&&a)return a(i,!0);if(s)return s(i,!0);var l=new Error("Cannot find module '"+i+"'");throw l.code="MODULE_NOT_FOUND",l}var c=n[i]={exports:{}};e[i][0].call(c.exports,function(t){var n=e[i][1][t];return o(n?n:t)},c,c.exports,t,e,n,r)}return n[i].exports}for(var s="function"==typeof require&&require,i=0;i<r.length;i++)o(r[i]);return o}({1:[function(t,e,n){var r;r=function(){function t(){}return t._NONCE_TAG="__nc",t._SKEY_TAG="storage_key",t._DEF_ROOT=".v1.stor.vlt12",t.RELAY_TOKEN_LEN=32,t.RELAY_TOKEN_TIMEOUT=6e4,t.RELAY_SESSION_TIMEOUT=3e5,t.RELAY_COMMANDS=["count","upload","download","delete"],t.RELAY_AJAX_TIMEOUT=5e3,t}(),e.exports=r},{}],2:[function(t,e,n){var r,o,s,i;r=t("config"),s=t("keys"),i=t("nacl"),o=function(){function t(t,e){this.storage_key=null!=t?t:null,null==e&&(e=null),this.root=e?"."+e+r._DEF_ROOT:r._DEF_ROOT,this.storage_key||this._loadKey(),this.storage_key||this.newKey()}return t.prototype.tag=function(t){return t&&t+this.root},t.prototype._saveKey=function(){return this._set(r._SKEY_TAG,this.storage_key.toString())},t.prototype._loadKey=function(){var t;return t=this._get(r._SKEY_TAG),t?this.setKey(s.fromString(t)):void 0},t.prototype.selfDestruct=function(t){return t?this._local_remove(this.tag(r._SKEY_TAG)):void 0},t.prototype.setKey=function(t){return this.storage_key=t,this._saveKey()},t.prototype.newKey=function(){return this.setKey(i.makeSecretKey())},t.prototype.save=function(t,e){var n,o,s;return t&&e?(o=i.use(),e=o.encode_utf8(JSON.stringify(e)),s=o.crypto_secretbox_random_nonce(),n=o.crypto_secretbox(e,s,this.storage_key.key),this._set(t,n.toBase64()),this._set(r._NONCE_TAG+"."+t,s.toBase64()),!0):null},t.prototype.get=function(t){var e,n,o,s;return(n=this._get(t))&&(s=this._get(r._NONCE_TAG+"."+t))?(o=i.use(),e=o.crypto_secretbox_open(n.fromBase64(),s.fromBase64(),this.storage_key.key),JSON.parse(o.decode_utf8(e))):null},t.prototype.remove=function(t){var e,n,o,s;for(o=[t,r._NONCE_TAG+"."+t],e=0,n=o.length;n>e;e++)s=o[e],this._local_remove(this.tag(s));return!0},t.prototype._get=function(t){return this._local_get(this.tag(t))},t.prototype._set=function(t,e){return t&&e?(this._local_set(this.tag(t),e),e):null},t.prototype._local_get=function(t){return this._storage().get(t)||null},t.prototype._local_set=function(t,e){return this._storage().set(t,e)},t.prototype._local_remove=function(t){return this._storage().remove(t)},t.prototype._storage=function(){return t._storageDriver||t.startStorageSystem(),t._storageDriver},t._storageDriver=null,t.startStorageSystem=function(t){if(!t)throw new Error("The driver parameter cannot be empty.");return this._storageDriver=t},t}(),e.exports=o},{config:1,keys:5,nacl:9}],3:[function(t,e,n){var r,o;o=t("nacl"),r=function(){function t(t,e,n){var r,o,s,i;if(this.id=t,this.keyRing=e,null==n&&(n=null),!this.id||!this.keyRing)throw new Error("KeyRatchet - missing params");for(s=this._roles,r=0,o=s.length;o>r;r++)i=s[r],this[i]=this.keyRing.getKey(this.keyTag(i));n&&this.startRatchet(n)}return t.prototype.last_key=null,t.prototype.conf_key=null,t.prototype.next_key=null,t.prototype._roles=["last_key","conf_key","next_key"],t.prototype.keyTag=function(t){return t+"_"+this.id},t.prototype.storeKey=function(t){return this.keyRing.saveKey(this.keyTag(t),this[t])},t.prototype.startRatchet=function(t){var e,n,r,s;for(s=["conf_key","last_key"],e=0,r=s.length;r>e;e++)n=s[e],this[n]||(this[n]=t,this.storeKey(n));return this.next_key?void 0:(this.next_key=o.makeKeyPair(),this.storeKey("next_key"))},t.prototype.pushKey=function(t){var e,n,r,o,s;for(this.last_key=this.conf_key,this.conf_key=this.next_key,this.next_key=t,r=this._roles,o=[],e=0,n=r.length;n>e;e++)s=r[e],o.push(this.storeKey(s));return o},t.prototype.confKey=function(t){var e,n,r,o;if(null!=this.conf_key&&this.conf_key.equal(t))return!1;for(this.last_key=this.conf_key,this.conf_key=t,r=["last_key","conf_key"],e=0,n=r.length;n>e;e++)o=r[e],this.storeKey(o);return!0},t.prototype.curKey=function(){return this.conf_key?this.conf_key:this.last_key},t.prototype.h2_last_key=function(){return o.h2(this.last_key.boxPk)},t.prototype.h2_conf_key=function(){return o.h2(this.conf_key.boxPk)},t.prototype.h2_next_key=function(){return o.h2(this.next_key.boxPk)},t.prototype.keyByHash=function(t){var e,n,r,s;for(r=this._roles,e=0,n=r.length;n>e;e++)if(s=r[e],o.h2(this[s].boxPk)===t)return this[s]},t.prototype.isNextKeyHash=function(t){return this.h2_next_key().equal(t)},t.prototype.toStr=function(){return JSON.stringify(this).toBase64()},t.prototype.fromStr=function(t){return Utils.extend(this,JSON.parse(t.fromBase64()))},t}(),e.exports=r,window.__CRYPTO_DEBUG&&(window.KeyRatchet=r)},{nacl:9}],4:[function(t,e,n){var r,o,s,i,u,a,l={}.hasOwnProperty;r=t("config"),o=t("crypto_storage"),i=t("keys"),u=t("nacl"),a=t("utils"),s=function(){function t(t,e){var n;null==e&&(e=null),e&&(n=i.fromString(e),this.storage=new o(n,t)),this.storage||(this.storage=new o(null,t)),this._ensureKeys()}return t.prototype._ensureKeys=function(){return this._loadCommKey(),this._loadGuestKeys()},t.prototype._loadCommKey=function(){return this.comm_key=this.getKey("comm_key"),this.comm_key?void 0:(this.comm_key=u.makeKeyPair(),this.saveKey("comm_key",this.comm_key))},t.prototype._loadGuestKeys=function(){var t,e,n,r,o;for(this.registry=this.storage.get("guest_registry")||[],this.guest_keys={},r=this.registry,o=[],t=0,e=r.length;e>t;t++)n=r[t],o.push(this.guest_keys[n]=this.storage.get(n+".guest"));return o},t.prototype.commFromSeed=function(t){return this.comm_key=u.fromSeed(u.encode_utf8(t)),this.storage.save("comm_key",this.comm_key.toString())},t.prototype.commFromSecKey=function(t){return this.comm_key=u.fromSecretKey(t),this.storage.save("comm_key",this.comm_key.toString())},t.prototype.tagByHpk=function(t){var e,n,r;n=this.guest_keys;for(e in n)if(l.call(n,e)&&(r=n[e],t===u.h2(r.fromBase64()).toBase64()))return e},t.prototype.getMasterKey=function(){return this.storage.storage_key.key2str("key")},t.prototype.getPubCommKey=function(){return this.comm_key.strPubKey()},t.prototype.saveKey=function(t,e){return this.storage.save(t,e.toString()),e},t.prototype.getKey=function(t){var e;return e=this.storage.get(t),e?i.fromString(e):null},t.prototype._addRegistry=function(t){return t?this.registry.indexOf(t)>-1?void 0:this.registry.push(t):null},t.prototype._saveNewGuest=function(t,e){return t&&e?(this.storage.save("guest["+t+"]",e),this.storage.save("guest_registry",this.registry)):null},t.prototype._removeGuestRecord=function(t){var e;return t?(this.storage.remove("guest["+t+"]"),e=this.registry.indexOf(t),e>-1?(this.registry.splice(e,1),this.storage.save("guest_registry",this.registry)):void 0):null},t.prototype.addGuest=function(t,e){return t&&e?(e=e.trimLines(),this._addRegistry(t),this.guest_keys[t]=e,this._saveNewGuest(t,e)):null},t.prototype.addTempGuest=function(t,e){return t&&e?(e=e.trimLines(),this.guest_keys[t]=e,a.delay(r.RELAY_SESSION_TIMEOUT,function(e){return function(){return delete e.guest_keys[t]}}(this))):null},t.prototype.removeGuest=function(t){return t&&this.guest_keys[t]?(this.guest_keys[t]=null,delete this.guest_keys[t],this._removeGuestRecord(t)):null},t.prototype.getGuestKey=function(t){return t&&this.guest_keys[t]?new i({boxPk:this.getGuestRecord(t).fromBase64()}):null},t.prototype.getGuestRecord=function(t){return t&&this.guest_keys[t]?this.guest_keys[t]:null},t.prototype.selfDestruct=function(t){var e,n,r,o;if(!t)return null;for(o=this.registry.slice(),n=0,r=o.length;r>n;n++)e=o[n],this.removeGuest(e);return this.storage.remove("guest_registry"),this.storage.remove("comm_key"),this.storage.selfDestruct(t)},t}(),e.exports=s,window.__CRYPTO_DEBUG&&(window.KeyRing=s)},{config:1,crypto_storage:2,keys:5,nacl:9,utils:13}],5:[function(t,e,n){var r,o,s={}.hasOwnProperty;o=t("utils"),r=function(){function t(t){t&&o.extend(this,t)}return t.prototype.toString=function(){return JSON.stringify(this.constructor.keys2str(this))},t.fromString=function(t){return t?this.str2keys(JSON.parse(t.trimLines())):null},t.prototype.key2str=function(t){return t&&null!=this[t]?this[t].toBase64():null},t.prototype.strPubKey=function(){return this.boxPk.toBase64()},t.prototype.strSecKey=function(){return this.boxSk.toBase64()},t.prototype.equal=function(t){return this.strPubKey()!==t.strPubKey()?!1:null!=this.boxSk!=(null!=t.boxSk)?!1:null!=this.boxSk?this.strSecKey()===t.strSecKey():!0},t.keys2str=function(e){var n,r,o;r=new t;for(n in e)s.call(e,n)&&(o=e[n],r[n]=o.toBase64());return r},t.str2keys=function(e){var n,r,o;r=new t;for(n in e)s.call(e,n)&&(o=e[n],r[n]=o.fromBase64());return r},t}(),e.exports=r,window.__CRYPTO_DEBUG&&(window.Keys=r)},{utils:13}],6:[function(t,e,n){var r,o,s,i,u;r=t("config"),o=t("keyring"),i=t("nacl"),u=t("utils"),s=function(){function t(t,e){this.identity=t,null==e&&(e=null),this.keyRing=new o(this.identity,e),this.session_keys={},this.session_relay={},this.session_timeout={}}return t.fromSeed=function(e,n,r){var o;return null==n&&(n=e),null==r&&(r=null),o=new t(n,r),o.keyRing.commFromSeed(n),o._hpk=null,o},t.fromSecKey=function(e,n,r){var o;return null==r&&(r=null),o=new t(n,r),o.keyRing.commFromSecKey(e),o._hpk=null,o},t.prototype.hpk=function(){return this._hpk?this._hpk:this._hpk=i.h2(this.keyRing.comm_key.boxPk)},t.prototype.getPubCommKey=function(){return this.keyRing.getPubCommKey()},t.prototype.createSessionKey=function(t){if(!t)throw new Error("createSessionKey - no sess_id");return null!=this.session_keys[t]?this.session_keys[t]:(this.session_keys[t]=i.makeKeyPair(),this.session_timeout[t]=u.delay(r.RELAY_SESSION_TIMEOUT,function(e){return function(){return e.session_keys[t]=null,delete e.session_keys[t],e.session_timeout[t]=null,delete e.session_timeout[t],e.session_relay[t]=null,delete e.session_relay[t]}}(this)),this.session_keys[t])},t.prototype.rawEncodeMessage=function(t,e,n){var r,o;if(null==t||null==e||null==n)throw new Error("rawEncodeMessage: missing params");return r=this._make_nonce(),o={nonce:r.toBase64(),ctext:i.use().crypto_box(this._parseData(t),r,e,n).toBase64()}},t.prototype.rawDecodeMessage=function(t,e,n,r){var o;if(null==t||null==e||null==n||null==r)throw new Error("rawEncodeMessage: missing params");return o=i.use(),JSON.parse(o.decode_utf8(o.crypto_box_open(e,t,n,r)))},t.prototype.encodeMessage=function(t,e,n,r){var o,s;if(null==n&&(n=!1),null==r&&(r=null),null==t||null==e)throw new Error("encodeMessage: missing params");if(null==(o=this._gPk(t)))throw new Error("encodeMessage: don't know guest "+t);return s=this._getSecretKey(t,n,r),this.rawEncodeMessage(e,o,s)},t.prototype.decodeMessage=function(t,e,n,r,o){var s,i;if(null==r&&(r=!1),null==o&&(o=null),null==t||null==e||null==n)throw new Error("decodeMessage: missing params");if(null==(s=this._gPk(t)))throw new Error("decodeMessage: don't know guest "+t);return i=this._getSecretKey(t,r,o),this.rawDecodeMessage(e.fromBase64(),n.fromBase64(),s,i)},t.prototype.connectToRelay=function(t){return t.openConnection().then(function(e){return function(){return t.connectMailbox(e).then(function(){return e.lastRelay=t})}}(this))},t.prototype.sendToVia=function(t,e,n){return this.connectToRelay(e).then(function(r){return function(){return r.relay_send(t,n,e)}}(this))},t.prototype.getRelayMessages=function(t){return this.connectToRelay(t).then(function(t){return function(){return t.relay_messages()}}(this))},t.prototype.relay_count=function(){if(!this.lastRelay)throw new Error("relay_count - no open relay");return this.lastRelay.count(this).then(function(t){return function(){return t.count=parseInt(t.lastRelay.result)}}(this))},t.prototype.relay_send=function(t,e){var n;if(!this.lastRelay)throw new Error("mbx: relay_send - no open relay");return n=this.encodeMessage(t,e),this.lastMsg=n,this.lastRelay.upload(this,i.h2(this._gPk(t)),n)},t.prototype.relay_messages=function(){if(!this.lastRelay)throw new Error("relay_messages - no open relay");return this.lastRelay.download(this).then(function(t){return function(){var e,n,r,o,s,i;for(t.lastDownload=[],o=t.lastRelay.result,s=[],n=0,r=o.length;r>n;n++)e=o[n],(i=t.keyRing.tagByHpk(e.from))&&(e.fromTag=i,e.msg=t.decodeMessage(i,e.nonce,e.data),null!=e.msg&&delete e.data),s.push(t.lastDownload.push(e));return s}}(this))},t.prototype.relay_nonce_list=function(){if(!this.lastDownload)throw new Error("relay_nonce_list - no metadata");return u.map(this.lastDownload,function(t){return t.nonce})},t.prototype.relay_delete=function(t){if(!this.lastRelay)throw new Error("relay_delete - no open relay");return this.lastRelay["delete"](this,t)},t.prototype.clean=function(t){return this.getRelayMessages(t).then(function(t){return function(){return t.relay_delete(t.relay_nonce_list())}}(this))},t.prototype.selfDestruct=function(t){return t?this.keyRing.selfDestruct(t):null},t.prototype._gKey=function(t){return t?this.keyRing.getGuestKey(t):null},t.prototype._gPk=function(t){var e;return t?null!=(e=this._gKey(t))?e.boxPk:void 0:null},t.prototype._gHpk=function(t){return t?i.h2(this._gPk(t)):null},t.prototype._getSecretKey=function(t,e,n){return n?this._gPk(n):e?this.session_keys[t].boxSk:this.keyRing.comm_key.boxSk},t.prototype._parseData=function(t){return"Uint8Array"===u.type(t)?t:i.use().encode_utf8(JSON.stringify(t))},t.prototype._make_nonce=function(t){var e,n,r,o,s,a;if(null==t&&(t=parseInt(Date.now()/1e3)),s=i.use().crypto_box_random_nonce(),null==s||24!==s.length)throw new Error("RNG failed, try again?");for(e=u.itoa(t),n=r=0;7>=r;n=++r)s[n]=0;for(n=o=0,a=e.length-1;a>=0?a>=o:o>=a;n=a>=0?++o:--o)s[8-e.length+n]=e[n];return s},t}(),e.exports=s,window.__CRYPTO_DEBUG&&(window.MailBox=s)},{config:1,keyring:4,nacl:9,utils:13}],7:[function(t,e,n){e.exports={Utils:t("utils"),Mixins:t("mixins"),Nacl:t("nacl"),Keys:t("keys"),SimpleStorageDriver:t("test_driver"),CryptoStorage:t("crypto_storage"),KeyRing:t("keyring"),MailBox:t("mailbox"),Relay:t("relay"),RachetBox:t("rachetbox"),startStorageSystem:function(t){return this.CryptoStorage.startStorageSystem(t)},setAjaxImpl:function(t){return this.Utils.setAjaxImpl(t)}},window&&(window.glow=e.exports)},{crypto_storage:2,keyring:4,keys:5,mailbox:6,mixins:8,nacl:9,rachetbox:10,relay:11,test_driver:12,utils:13}],8:[function(t,e,n){var r,o,s,i,u;for(o=t("utils"),o.include(String,{toCodeArray:function(){var t,e,n,r;for(n=[],t=0,e=this.length;e>t;t++)r=this[t],n.push(r.charCodeAt());return n},toUTF8:function(){return unescape(encodeURIComponent(this))},fromUTF8:function(){return decodeURIComponent(escape(this))},toUint8Array:function(){return new Uint8Array(this.toUTF8().toCodeArray())},toUint8ArrayRaw:function(){return new Uint8Array(this.toCodeArray())},fromBase64:function(){return new Uint8Array(atob(this).toCodeArray())},trimLines:function(){return this.replace("\r\n","").replace("\n","").replace("\r","")}}),u=[Array,Uint8Array,Uint16Array],s=0,i=u.length;i>s;s++)r=u[s],o.include(r,{fromCharCodes:function(){var t;return function(){var e,n,r;for(r=[],e=0,n=this.length;n>e;e++)t=this[e],r.push(String.fromCharCode(t));return r}.call(this).join("")},toBase64:function(){return btoa(this.fromCharCodes())},xorWith:function(t){var e,n;return this.length!==t.length?null:new Uint8Array(function(){var r,o,s;for(s=[],n=r=0,o=this.length;o>r;n=++r)e=this[n],s.push(e^t[n]);return s}.call(this))},equal:function(t){var e,n,r,o;if(this.length!==t.length)return!1;for(e=n=0,r=this.length;r>n;e=++n)if(o=this[e],o!==t[e])return!1;return!0}});o.include(Uint8Array,{concat:function(t){var e;return e=new Uint8Array(this.byteLength+t.byteLength),e.set(new Uint8Array(this),0),e.set(t,this.byteLength),e},fill_with:function(t){var e,n,r,o;for(e=n=0,r=this.length;r>n;e=++n)o=this[e],this[e]=t;return this}}),e.exports={}},{utils:13}],9:[function(t,e,n){var r,o,s,i;i="undefined"!=typeof nacl_factory&&null!==nacl_factory?nacl_factory:t("js-nacl"),r=t("keys"),s=t("utils"),o=function(){function t(){}return t.HEAP_SIZE=Math.pow(2,23),t._instance=null,t._unloadTimer=null,t.use=function(){return this._unloadTimer&&clearTimeout(this._unloadTimer),this._unloadTimer=setTimeout(function(){return t.unload()},15e3),window.__nacl_instance||(window.__nacl_instance=i.instantiate(this.HEAP_SIZE)),window.__nacl_instance},t.unload=function(){return this._unloadTimer=null,window.__nacl_instance=null,delete window.__nacl_instance},t.makeSecretKey=function(){return new r({key:this.use().random_bytes(this.use().crypto_secretbox_KEYBYTES)})},t.random=function(t){return null==t&&(t=32),this.use().random_bytes(t)},t.makeKeyPair=function(){return new r(this.use().crypto_box_keypair())},t.fromSecretKey=function(t){return new r(this.use().crypto_box_keypair_from_raw_sk(t))},t.fromSeed=function(t){return new r(this.use().crypto_box_keypair_from_seed(t))},t.sha256=function(t){return this.use().crypto_hash_sha256(t)},t.to_hex=function(t){return this.use().to_hex(t)},t.from_hex=function(t){return this.use().from_hex(t)},t.encode_utf8=function(t){return this.use().encode_utf8(t)},t.decode_utf8=function(t){return this.use().decode_utf8(t)},t.h2=function(t){var e;return"String"===s.type(t)&&(t=t.toUint8ArrayRaw()),e=new Uint8Array(32+t.length),e.fill_with(0),e.set(t,32),this.sha256(this.sha256(e))},t.h2_64=function(e){return t.h2(e.fromBase64()).toBase64()},t}(),e.exports=o,window.__CRYPTO_DEBUG&&(window.Nacl=o)},{"js-nacl":void 0,keys:5,utils:13}],10:[function(t,e,n){var r,o,s,i,u,a,l,c=function(t,e){function n(){this.constructor=t}for(var r in e)h.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},h={}.hasOwnProperty;l=t("utils"),u=t("nacl"),s=t("keys"),o=t("keyring"),r=t("keyratchet"),i=t("mailbox"),a=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return c(e,t),e.prototype._loadRatchets=function(t){var e;return e=this._gHpk(t).toBase64(),this.kr_local=new r("local_"+e+"_for_"+this.hpk().toBase64(),this.keyRing,this.keyRing.comm_key),this.kr_guest=new r("guest_"+e+"_for_"+this.hpk().toBase64(),this.keyRing,this.keyRing.getGuestKey(t))},e.prototype.relay_send=function(t,e){var n,r;if(!this.lastRelay)throw new Error("rbx: relay_send - no open relay");if(!t||!e)throw new Error("rbx: relay_send - missing params");return this._loadRatchets(t),r={org_msg:e},null==e.got_key&&(r.next_key=this.kr_local.next_key.strPubKey()),null==e.got_key?(n=this.rawEncodeMessage(r,this.kr_guest.conf_key.boxPk,this.kr_local.conf_key.boxSk),this.lastMsg=n):n=this.rawEncodeMessage(r,this.kr_guest.last_key.boxPk,this.kr_local.conf_key.boxSk),this.lastRelay.upload(this,u.h2(this._gPk(t)),n)},e.prototype._try_keypair=function(t,e,n,r){var o,s;try{return this.rawDecodeMessage(t.fromBase64(),e.fromBase64(),n,r)}catch(s){return o=s,null}},e.prototype.decodeMessage=function(t,n,r,o,s){var i,u,a,l,c,h;if(null==o&&(o=!1),null==s&&(s=null),o)return e.__super__.decodeMessage.call(this,t,n,r,o,s);if(null==t||null==n||null==r)throw new Error("decodeMessage: missing params");for(this._loadRatchets(t),a=[[this.kr_guest.conf_key.boxPk,this.kr_local.conf_key.boxSk],[this.kr_guest.last_key.boxPk,this.kr_local.last_key.boxSk],[this.kr_guest.conf_key.boxPk,this.kr_local.last_key.boxSk],[this.kr_guest.last_key.boxPk,this.kr_local.conf_key.boxSk]],i=u=0,c=a.length;c>u;i=++u)if(l=a[i],h=this._try_keypair(n,r,l[0],l[1]),null!=h)return h;return console.log("RatchetBox decryption failed: message from unknown guest or ratchet out of sync"),null},e.prototype.relay_messages=function(){return e.__super__.relay_messages.call(this).then(function(t){return function(){var e,n,r,o,i,a,l,c,h;for(h=[],o=t.lastDownload,e=0,n=o.length;n>e;e++)r=o[e],r.fromTag&&(t._loadRatchets(r.fromTag),null!=(null!=(i=r.msg)?i.next_key:void 0)&&t.kr_guest.confKey(new s({boxPk:r.msg.next_key.fromBase64()}))&&h.push({toTag:r.fromTag,key:r.msg.next_key,msg:{got_key:u.h2_64(r.msg.next_key)}}),null!=(null!=(a=r.msg)&&null!=(l=a.org_msg)?l.got_key:void 0)&&(r.msg=r.msg.org_msg,t.kr_local.isNextKeyHash(r.msg.got_key.fromBase64())&&t.kr_local.pushKey(u.makeKeyPair()),r.msg=null),null!=r.msg&&(r.msg=r.msg.org_msg));return(c=function(){var e;return h.length>0?(e=h.shift(),t.relay_send(e.toTag,e.msg).then(function(){return c()})):void 0})()}}(this))},e}(i),e.exports=a,window.__CRYPTO_DEBUG&&(window.RatchetBox=a)},{keyratchet:3,keyring:4,keys:5,mailbox:6,nacl:9,utils:13}],11:[function(t,e,n){var r,o,s,i,u,a=function(t,e){return function(){return t.apply(e,arguments)}},l=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};r=t("config"),o=t("keys"),s=t("nacl"),u=t("utils"),i=function(){function t(t){this.url=null!=t?t:null,this._ajax=a(this._ajax,this),this._reset_state(),this.lastError=null,this.RELAY_COMMANDS=["count","upload","download","delete"]}return t.prototype.openConnection=function(){return this.getServerToken().then(function(t){return function(){return t.getServerKey()}}(this))},t.prototype.getServerToken=function(){if(!this.url)throw new Error("getServerToken - no url");if(this.lastError=null,this.client_token||(this.client_token=s.random(r.RELAY_TOKEN_LEN)),this.client_token&&this.client_token.length!==r.RELAY_TOKEN_LEN)throw new Error("Token must be "+r.RELAY_TOKEN_LEN+" bytes");return this._ajax("start_session",this.client_token.toBase64()).then(function(t){return function(e){var n;return n=t._processData(e),t.relay_token=n[0].fromBase64(),t.diff=2===n.length?parseInt(n[1]):0,t.h2_relay_token=s.h2(t.relay_token),t._schedule_expire_session(r.RELAY_TOKEN_TIMEOUT),t.diff>4&&console.log("Relay "+t.url+" requested difficulty "+t.diff+". Session handshake may take longer."),t.diff>16?console.log("Attempting handshake at difficulty "+t.diff+"! This may take a while"):void 0}}(this))},t.prototype.getServerKey=function(){var t,e,n;if(!(this.url&&this.client_token&&this.relay_token))throw new Error("getServerKey - missing params");if(this.lastError=null,this.h2_client_token=s.h2(this.client_token).toBase64(),t=this.client_token.concat(this.relay_token),0===this.diff)n=s.h2(t).toBase64();else{for(e=s.random(32);!u.arrayZeroBits(s.h2(t.concat(e)),this.diff);)e=s.random(32);n=e.toBase64()}return this._ajax("verify_session",this.h2_client_token+"\r\n"+n+"\r\n").then(function(t){return function(e){var n;return n=e.fromBase64(),t.relay_key=new o({boxPk:n}),t.online=!0}}(this))},t.prototype.connectMailbox=function(t){var e,n,r,o,i,u,a;if(null==t||!this.online||null==this.relay_key||null==this.url)throw new Error("connectMailbox - missing params");return this.lastError=null,u="relay_"+this.url,e=t.createSessionKey(u).boxPk,t.keyRing.addTempGuest(u,this.relay_key.strPubKey()),delete this.relay_key,o=e.toBase64(),a=e.concat(this.relay_token).concat(this.client_token),n=s.h2(a),r=t.encodeMessage(u,n),r.pub_key=t.keyRing.getPubCommKey(),i=t.encodeMessage("relay_"+this.url,r,!0),this._ajax("prove",this.h2_client_token+"\r\n"+(o+"\r\n")+(i.nonce+"\r\n")+(""+i.ctext)).then(function(t){return function(t){}}(this))},t.prototype.runCmd=function(t,e,n){var r,o;if(null==n&&(n=null),null==t||null==e)throw new Error("runCmd - missing params");if(l.call(this.RELAY_COMMANDS,t)<0)throw new Error("Relay "+this.url+" doesn't support "+t);return r={cmd:t},n&&(r=u.extend(r,n)),o=e.encodeMessage("relay_"+this.url,r,!0),this._ajax("command",e.hpk().toBase64()+"\r\n"+(o.nonce+"\r\n")+(""+o.ctext)).then(function(n){return function(r){if("upload"!==t){if(null==r)throw new Error(n.url+" - "+t+" error");return"count"===t||"download"===t?n.result=n._processResponse(r,e,t):n.result=JSON.parse(r)}}}(this))},t.prototype._processResponse=function(t,e,n){var r,o,s;if(o=this._processData(t),2!==o.length)throw new Error(this.url+" - "+n+": Bad response");return s=o[0],r=o[1],e.decodeMessage("relay_"+this.url,s,r,!0)},t.prototype._processData=function(t){var e;return e=t.split("\r\n"),e.length>=2||(e=t.split("\n")),e},t.prototype.count=function(t){return this.runCmd("count",t)},t.prototype.upload=function(t,e,n){return this.runCmd("upload",t,{to:e.toBase64(),payload:n})},t.prototype.download=function(t){return this.runCmd("download",t)},t.prototype["delete"]=function(t,e){return this.runCmd("delete",t,{payload:e})},t.prototype._reset_state=function(){return this.client_token=null,this.online=!1,this.relay_token=null,this.relay_key=null,this.client_token_expiration=null},t.prototype._schedule_expire_session=function(t){return this.client_token_expiration&&clearTimeout(this.client_token_expiration),this.client_token_expiration=setTimeout(function(t){return function(){return t._reset_state()}}(this),t)},t.prototype._ajax=function(t,e){return u.ajax(this.url+"/"+t,e)},t}(),e.exports=i,window.__CRYPTO_DEBUG&&(window.Relay=i)},{config:1,keys:5,nacl:9,utils:13}],12:[function(t,e,n){var r;r=function(){function t(t,e){null==t&&(t="storage."),null==e&&(e=null),this._root_tag="__glow."+t,this._load(e)}return t.prototype._state=null,t.prototype._key_tag=function(t){return this._root_tag+"."+t},t.prototype.get=function(t){return this._state||this._load(),this._state[t]?this._state[t]:JSON.parse(localStorage.getItem(this._key_tag(t)))},t.prototype.set=function(t,e){return this._state||this._load(),this._state[t]=e,localStorage.setItem(this._key_tag(t),JSON.stringify(e)),this._persist()},t.prototype.remove=function(t){return this._state||this._load(),delete this._state[t],localStorage.removeItem(this._key_tag(t)),this._persist()},t.prototype._persist=function(){},t.prototype._load=function(t){return null==t&&(t=null),this._state=t?t:{},console.log("INFO: SimpleTestDriver uses localStorage and should not be used in production for permanent key storage.")},t}(),e.exports=r},{}],13:[function(t,e,n){var r,o;r=t("config"),o=function(){function t(){}return t.extend=function(t,e){var n,r;if("undefined"!=typeof $&&null!==$?$.extend:void 0)return $.extend(t,e);for(n in e)r=e[n],void 0!==e[n]&&(t[n]=e[n]);return t},t.map=function(t,e){return("undefined"!=typeof $&&null!==$?$.map:void 0)?"undefined"!=typeof $&&null!==$?$.map(t,e):void 0:Array.prototype.map.apply(t,[e])},t.include=function(t,e){return this.extend(t.prototype,e)},t.type=function(t){return void 0===t?"undefined":null===t?"null":Object.prototype.toString.call(t).replace("[","").replace("]","").split(" ")[1]},t.ajaxImpl=null,t.setAjaxImpl=function(t){return this.ajaxImpl=t},t.ajax=function(t,e){if(null===this.ajaxImpl)if("undefined"!=typeof Q&&null!==Q?Q.xhr:void 0)this.setAjaxImpl(function(t,e){return Q.xhr({method:"POST",url:t,headers:{Accept:"text/plain","Content-Type":"text/plain"},data:e,responseType:"text",timeout:r.RELAY_AJAX_TIMEOUT,disableUploadProgress:!0}).then(function(t){return t.data})});else{if(!(("undefined"!=typeof $&&null!==$?$.ajax:void 0)&&("undefined"!=typeof $&&null!==$?$.Deferred:void 0)))throw new Error("ajax implementation not set; use q-xhr or $http");console.log("default ajax impl: setting to zepto with promises"),this.setAjaxImpl(function(t,e){return $.ajax({url:t,type:"POST",dataType:"text",timeout:r.RELAY_AJAX_TIMEOUT,context:this,error:console.log,contentType:"text/plain",data:e})})}return this.ajaxImpl(t,e)},t.delay=function(t,e){return setTimeout(e,t)},t.itoa=function(t){var e,n,r,o,s,i;return 0>=t?new Uint8Array(function(){var t,e;for(e=[],n=t=0;7>=t;n=++t)e.push(0);return e}()):(s=[Math.floor,Math.pow,Math.log],e=s[0],o=s[1],r=s[2],i=e(r(t)/r(256)),new Uint8Array(function(){var r,s,u;for(u=[],n=r=s=i;0>=s?0>=r:r>=0;n=0>=s?++r:--r)u.push(e(t/o(256,n))%256);return u}()))},t.firstZeroBits=function(t,e){return t===t>>e<<e},t.arrayZeroBits=function(t,e){var n,r,o,s,i;for(i=e,r=o=0,s=1+e/8;s>=0?s>=o:o>=s;r=s>=0?++o:--o){if(n=t[r],0>=i)return!0;if(!(i>8))return this.firstZeroBits(n,i);if(i-=8,n>0)return!1}return!1},t.logStack=function(t){var e,n,r,o,s,i;for(t||(t=new Error("stackLog")),s=t.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@").split("\n"),o=[],e=n=0,r=s.length;r>n;e=++n)i=s[e],o.push(console.log(e+": "+i));return o},t}(),e.exports=o,window.__CRYPTO_DEBUG&&(window.Utils=o)},{config:1}]},{},[7]);
//# sourceMappingURL=theglow.js.map
